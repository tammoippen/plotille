language: python
dist: trusty
sudo: false

notifications:
  email: false

matrix:
    fast_finish: true
    allow_failures:
      - env: PYENV_VERSION=3.8-devn3.62 GiB    
    include:
      - env: PYENV_VERSION=2.7.15        PYENV_VERSION_STRING="Python 2.7.15"
      - env: PYENV_VERSION=3.5.6         PYENV_VERSION_STRING="Python 3.5.6"
      - env: PYENV_VERSION=3.6.7         PYENV_VERSION_STRING="Python 3.6.7"
      - env: PYENV_VERSION=3.7.1         PYENV_VERSION_STRING="Python 3.7.1"
      - env: PYENV_VERSION=3.8-dev       PYENV_VERSION_STRING="Python 3.8.0"
      - env: PYENV_VERSION=pypy2.7-6.0.0 PYENV_VERSION_STRING="PyPy 6.0.0"
      - env: PYENV_VERSION=pypy3.5-6.0.0 PYENV_VERSION_STRING="PyPy 6.0.0"

env:
  global:
    - PYENV_ROOT="$HOME/.travis-pyenv"
    - PYENV_CACHE_PATH="$HOME/.pyenv_cache"
    secure: "aEqZt0qnP/dPJpCHk/qpeeOW+Mf0k780083avEbU7mZ+sZABRRBq42aeYVVnTvqefgwiBgE0iw99YAg19ZVXdSWfKHc+XFSPdJ2INWPDPgp7Wh4S1feVVVtREUOhmGjK3azqEvOSGJLTqaavy7AHB/VIpZTD5WbR/QmM7/IcQkZjPZ9ifjt7JCTsiIZfqqBWVUOPxLh3ylCCjp9HX1ocYmZXXKv99HaTL6aHBofcN+WzmVd2cRyDFeVdxHbgJBmfo0agk7ITNvyvF9K8UjUS1ETOkeIJsX/6ZCtF3/70rfZxfpNcWiCiBmYUDrvbngNcnpopQFUudRutwnOK0IHteOzsXqsmm7kE2uOMyrQ/6/5TlWo/rLQv1iuRTETtB6ReSxqoEmP/SYUe/eAgrXiSCA4l7lnbc01LW4TydeTjijCeTVhbLbYYbhGRWvTX4S8k3+xSioS5Z6EvSCKPP+ajAo1oymzJ8EIUiRqEv5Rkt2XBkPgmeWi7KQPAsJvjGL/dOU1cw3b3O/BF+ABF9Rvf4jncJX7psMk6vt7uzS/lwzAMfjVPqp0UNJdCkKHZJupP7ZGQ+oWB1+SuEL+DtCugJQnqEg1mXQezp/dWWgwWTvqpZMzfNsywfLE1Sa4DxVWx2M3tc75xF9UAbS+Q2S/BhQO3eDF39bMWAp7oA8OsxoI="

cache:
  directories:
    - "${PYENV_CACHE_PATH:-$HOME/.pyenv_cache}"

before_install:
  - |
      if [[ -n "$PYENV_VERSION" ]]; then
        wget https://github.com/praekeltfoundation/travis-pyenv/releases/download/0.4.0/setup-pyenv.sh
        source setup-pyenv.sh
      fi
  - pip install poetry
  - poetry config settings.virtualenvs.create false

install:
  - poetry install
  - poetry show

script: poetry run pytest

after_success:
  - coveralls

before_deploy:
  - git stash --all
  - poetry build -f sdist

deploy:
  provider: script
  script: poetry publish -u tammoippen -p $PYPI_PASS
  skip_cleanup: true
  on:
    branch: master
    tags: true
    condition: $PYENV_VERSION = 3.6.7
